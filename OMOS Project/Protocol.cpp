//=======================================================================================
//= Fixes.cpp
//=======================================================================================
#include "StdAfx.h"

//------------------------------------------------------
//- Start
//------------------------------------------------------
bool ProtocolCore (BYTE protoNum,LPBYTE aRecv,int aLen,int aIndex,DWORD Encrypt,DWORD Serial)
{
	//--------------------------------------------------------------------------------
	Player.SetIndex(aIndex);
	//--------------------------------------------------------------------------------
	OBJECTSTRUCT *gObj = (OBJECTSTRUCT*)OBJECT_POINTER(aIndex);
	OBJECTSTRUCT *ObjTable = (OBJECTSTRUCT*)OBJECT_BASE;
	//--------------------------------------------------------------------------------

	switch(BYTE(protoNum))
	{
	case 0x00:
		//-----------------------------------------------------------------------------------------------------------------------------------------------------
		if(COMMAND_NAME("/post"))
		{
			//--------------------------------------------------------------------------------
			if(ReadINI.GetInt("Commands","PostCommandActive",INI_COMMANDS) == 0)
			{
				//--------------------------------------------------------------------------------
				Player.SendTextMsg(1,"This command is disabled!");
				//--------------------------------------------------------------------------------
			}
			//--------------------------------------------------------------------------------
			if(Player.GetLevel() < ReadINI.GetInt("Commands","PostCommandMinLevel",INI_COMMANDS))
			{
				//--------------------------------------------------------------------------------
				Player.SendTextMsg(1,"You Don't have req level for usage. Min level %d",ReadINI.GetInt("Commands","PostCommandMinLevel",INI_COMMANDS));
				//--------------------------------------------------------------------------------
				return false;
				//--------------------------------------------------------------------------------
			}
			//--------------------------------------------------------------------------------
			if(Player.GetMoney() > ReadINI.GetInt("Commands","PostCommandPrice",INI_COMMANDS))
			{
				//--------------------------------------------------------------------------------
				Player.RemoveMoney(ReadINI.GetInt("Commands","PostCommandPrice",INI_COMMANDS));
				//--------------------------------------------------------------------------------
			}
			else
			{
				//--------------------------------------------------------------------------------
				return false;
				//--------------------------------------------------------------------------------
			}
			//--------------------------------------------------------------------------------
			Player.SendAllTextMsg(1,"[Post] %s: %s",gObj->Name,(char*)aRecv+13+strlen("/post"));
			//--------------------------------------------------------------------------------
		}
		//-----------------------------------------------------------------------------------------------------------------------------------------------------
		else if(COMMAND_NAME("/drop"))
		{
			//--------------------------------------------------------------------------------
			if(Player.IsGameMaster() == false)
			{
				//--------------------------------------------------------------------------------
				return false;
				//--------------------------------------------------------------------------------
			}
			//--------------------------------------------------------------------------------
			DropItem(aIndex,(char*)aRecv+13+strlen("/drop"));
			//--------------------------------------------------------------------------------
		}
		//-----------------------------------------------------------------------------------------------------------------------------------------------------
		else if(COMMAND_NAME("/reload"))
		{
			//--------------------------------------------------------------------------------
			if(Player.IsGameMaster() == false)
			{
				//--------------------------------------------------------------------------------
				return false;
				//--------------------------------------------------------------------------------
			}
			//--------------------------------------------------------------------------------
			Config.EditMemory();
			LoadIPBlock();
			//--------------------------------------------------------------------------------
			Player.SendTextMsg(1,"[Reload] Server Configuration Reloaded!");
			Player.SendTextMsg(1,"[Reload] Blocked IP Configuration Reloaded!");
			//--------------------------------------------------------------------------------
		}
		//-----------------------------------------------------------------------------------------------------------------------------------------------------
		else if(COMMAND_NAME("/omon"))
		{
			Player.SendTextMsg(1,"This server is powered by OMON Project!");
			Player.SendTextMsg(1,"http://tinyurl/omon11/");
			Player.SendTextMsg(1,"OMON Project is developed by System32");
			Player.SendTextMsg(1,"MSN/Email: system.32@hotmail.com");
		}
		//-----------------------------------------------------------------------------------------------------------------------------------------------------
		break;
	case 0x03:
		//-----------------------------------------------------------------------------------------------------------------------------------------------------
		Player.SendTextMsg(0,ConnectMessage,gObj->Name);
		//-----------------------------------------------------------------------------------------------------------------------------------------------------
		break;
	case 0x30:
		//-----------------------------------------------------------------------------------------------------------------------------------------------------
		//NPCID = aRecv[4] + aRecv[3] * 256
		//NPCTalk
		//-----------------------------------------------------------------------------------------------------------------------------------------------------
		break;
	case 0xBC:
		//-----------------------------------------------------------------------------------------------------------------------------------------------------
		if(ObjTable[aIndex].m_IfState.use > 0 && ObjTable[aIndex].m_IfState.type != 12)
		{
			//--------------------------------------------------------------------------------
			return true;
			//--------------------------------------------------------------------------------
		}
		//-----------------------------------------------------------------------------------------------------------------------------------------------------
		break;
	case 0x95:
		//-----------------------------------------------------------------------------------------------------------------------------------------------------
		//GoldenArcher
		//-----------------------------------------------------------------------------------------------------------------------------------------------------
		break;
	case 0x26:
		//-----------------------------------------------------------------------------------------------------------------------------------------------------
		//CGUseItemRecv((PMSG_USEITEM*)aRecv,aIndex);
		//-----------------------------------------------------------------------------------------------------------------------------------------------------
		break;
	case 0x17:
		//-----------------------------------------------------------------------------------------------------------------------------------------------------
		//CRateSystem.Work(aIndex,gObj->MapNumber);
		//-----------------------------------------------------------------------------------------------------------------------------------------------------
		break;
	case 0xF1:
		//-----------------------------------------------------------------------------------------------------------------------------------------------------
		if(aRecv[3] == 0x01)
		{
			//--------------------------------------------------------------------------------
			char IPAddr[16];
			Player.GetIP(IPAddr);
			//--------------------------------------------------------------------------------
			for(int x=1;x < IPBlockCount;x++)
			{
				//--------------------------------------------------------------------------------
				if(!strcmp(IPBlockInfo[x].IP,IPAddr))
				{
					//--------------------------------------------------------------------------------
					Player.Disconnect();
					//--------------------------------------------------------------------------------
					return false;
					//--------------------------------------------------------------------------------
				}
				//--------------------------------------------------------------------------------
			}
		}
		//-----------------------------------------------------------------------------------------------------------------------------------------------------
		break;
	}
	//--------------------------------------------------------------------------------
	DataRecv(protoNum,aRecv,aLen,aIndex,Encrypt,Serial);
	//--------------------------------------------------------------------------------
	return true;
	//--------------------------------------------------------------------------------
}